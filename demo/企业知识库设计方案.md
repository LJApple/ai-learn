# 企业智能知识库设计方案

## 1. 项目概述

### 1.1 项目目标
构建面向大型企业（500+ 人）的 AI 智能问答知识库系统，基于开源技术栈自建，实现企业知识的智能化管理和高效检索。

### 1.2 核心能力
- **智能问答**：员工通过自然语言提问，系统基于企业知识库给出准确答案
- **多源接入**：支持文档、Wiki、网页等多种知识来源
- **权限管控**：基于用户权限过滤检索内容
- **可溯源**：答案标注知识来源，支持追溯原文

### 1.3 目标规模
| 指标 | 数值 |
|------|------|
| 用户数 | 500+ |
| 文档数量 | 100,000+ |
| QPS | 100+ |
| 向量数据量 | 10M+ |

---

## 2. 系统架构

### 2.1 总体架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              用户层 (User Layer)                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐                 │
│  │ Web 界面 │  │企业微信/ │  │  Slack   │  │  API     │                 │
│  │          │  │ 钉钉集成 │  │          │  │  SDK     │                 │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘                 │
└─────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                              网关层 (Gateway Layer)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                    │
│  │  API Gateway │  │  认证授权    │  │  限流/日志   │                    │
│  │   (Kong/Nginx)│ │   (OAuth2/JWT)│ │              │                    │
│  └──────────────┘  └──────────────┘  └──────────────┘                    │
└─────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                            应用服务层 (Service Layer)                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │
│  │   问答服务      │  │   文档管理服务  │  │   用户管理服务  │          │
│  │  (RAG Pipeline) │  │     (CRUD)      │  │    (RBAC)       │          │
│  │                 │  │                 │  │                 │          │
│  │ - Query Rewrite │  │ - Upload        │  │ - User/Role     │          │
│  │ - Retrieval     │  │ - Parse         │  │ - Permission    │          │
│  │ - Rerank        │  │ - Index         │  │ - Audit Log     │          │
│  │ - Generation    │  │ - Sync          │  │                 │          │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘          │
└─────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                           数据存储层 (Storage Layer)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │ 向量数据库   │  │  关系数据库  │  │   对象存储   │  │    缓存      │ │
│  │  (Milvus/    │  │  (PostgreSQL)│  │  (MinIO/S3)  │  │  (Redis)     │ │
│  │  Qdrant)     │  │              │  │              │  │              │ │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                           LLM 服务层 (LLM Layer)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                   │
│  │ 私有部署 LLM │  │  Embedding   │  │  Rerank      │                   │
│  │ (Qwen/Llama) │  │   Model      │  │  Model       │                   │
│  │  或 vLLM     │  │              │  │              │                   │
│  └──────────────┘  └──────────────┘  └──────────────┘                   │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 RAG 检索流程

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ 用户提问 │ →  │ 查询重写 │ →  │ 向量检索 │ →  │ 重排序  │ →  │ 答案生成 │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
                    ↓             ↓             ↓              ↓
               Query         Embedding      Rerank        LLM
               Expansion       Search        Model       Generation
```

---

## 3. 核心模块设计

### 3.1 数据摄取管道 (Ingestion Pipeline)

```
┌────────────────────────────────────────────────────────────────────┐
│                        数据摄取管道                                 │
│                                                                    │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐           │
│  │ 文档源  │ → │ 格式解析 │ → │ 文本分块 │ → │ Embedding│           │
│  └─────────┘   └─────────┘   └─────────┘   └─────────┘           │
│      ↓             ↓             ↓              ↓                  │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐           │
│  │  PDF    │   │ Parser  │   │ Chunker │   │  Model  │           │
│  │  Word   │   │         │   │         │   │         │           │
│  │  Excel  │   │         │   │         │   │         │           │
│  │  PPT    │   │         │   │         │   │         │           │
│  │ Markdown│   │         │   │         │   │         │           │
│  │  HTML   │   │         │   │         │   │         │           │
│  │  Wiki   │   │         │   │         │   │         │           │
│  │ Confluce│   │         │   │         │   │         │           │
│  └─────────┘   └─────────┘   └─────────┘   └─────────┘           │
│                                                ↓                   │
│                                          ┌─────────┐              │
│                                          │向量存储 │              │
│                                          └─────────┘              │
└────────────────────────────────────────────────────────────────────┘
```

### 3.2 分块策略

| 策略 | 说明 | 适用场景 |
|------|------|----------|
| 固定大小分块 | 按固定 token 数切分 | 通用场景 |
| 语义分块 | 基于句子/段落边界 | 保持语义完整性 |
| 递归分块 | 多级粒度分块 | 提高召回率 |
| 元数据增强 | 保留标题、层级信息 | 结构化文档 |

**推荐配置**：
- 分块大小：500-1500 tokens
- 重叠比例：10-20%
- 最小分块：100 tokens

### 3.3 检索策略

#### 混合检索
```
用户问题
    ↓
┌─────────────────┐
│  查询预处理      │
│  - 去停用词      │
│  - 同义词扩展    │
│  - 意图识别      │
└─────────────────┘
    ↓
┌──────────────┐ ┌──────────────┐
│ 向量检索       │ │ 关键词检索    │
│ (Semantic)    │ │  (BM25)      │
└──────────────┘ └──────────────┘
    ↓                ↓
    └────────┬───────┘
             ↓
      ┌──────────────┐
      │   结果融合    │
      │ (RRF/加权)   │
      └──────────────┘
             ↓
      ┌──────────────┐
      │   重排序      │
      │  (Reranker)  │
      └──────────────┘
             ↓
      ┌──────────────┐
      │  Top-K 结果  │
      └──────────────┘
```

#### 查询优化
- **查询重写**：修正错别字、补充上下文
- **查询扩展**：同义词、相关词扩展
- **HyDE**：生成假设文档用于检索
- **多轮对话**：历史上下文合并

### 3.4 权限控制

```
用户请求
    ↓
┌─────────────────┐
│  身份认证        │
│  (JWT/OAuth2)   │
└─────────────────┘
    ↓
┌─────────────────┐
│  权限解析        │
│  - 部门权限      │
│  - 角色权限      │
│  - 文档级别权限  │
└─────────────────┘
    ↓
┌─────────────────┐
│  向量检索过滤    │
│  WHERE user_id   │
│  IN doc.acl      │
└─────────────────┘
    ↓
┌─────────────────┐
│  结果脱敏        │
└─────────────────┘
```

---

## 4. 技术选型

### 4.1 核心技术栈

| 类别 | 推荐方案 | 备选方案 | 选择理由 |
|------|----------|----------|----------|
| **后端框架** | FastAPI | Flask, LangServe | 高性能、异步支持、自动文档 |
| **向量数据库** | Milvus | Qdrant, Weaviate, pgvector | 大规模、性能优、云原生 |
| **关系数据库** | PostgreSQL | MySQL | 可靠性、pgvector 扩展 |
| **对象存储** | MinIO | AWS S3, 阿里云 OSS | 自建友好、S3 兼容 |
| **缓存** | Redis | Memcached | 功能丰富、持久化支持 |
| **消息队列** | RabbitMQ | Kafka, Redis | 成熟、易用 |
| **LLM 推理** | vLLM | Ollama, TextGen | 高性能、PagedAttention |
| **Embedding** | bge-large | jina, m3e | 中文效果优 |
| **LLM 模型** | Qwen2.5 | Llama 3.1, DeepSeek | 中文能力强、开源 |
| **Rerank** | bge-reranker | Cohere Rerank | 效果好、开源 |
| **RAG 框架** | LangChain | LlamaIndex, Haystack | 生态成熟、社区活跃 |
| **前端框架** | Next.js | Vue, React | 服务端渲染、SEO 友好 |
| **UI 组件** | shadcn/ui | Ant Design, Material-UI | 现代化、可定制 |

### 4.2 基础设施

| 组件 | 推荐方案 | 说明 |
|------|----------|------|
| 容器编排 | Kubernetes | 大规模部署必选 |
| 服务网格 | Istio | 可选，用于微服务治理 |
| 监控 | Prometheus + Grafana | 指标监控 |
| 日志 | ELK / Loki | 日志聚合分析 |
| 链路追踪 | Jaeger / SkyWalking | 分布式追踪 |
| 网关 | Kong / Nginx | API 网关 |

---

## 5. 数据库设计

### 5.1 PostgreSQL 核心表结构

```sql
-- 用户表
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    department_id UUID,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 角色表
CREATE TABLE roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT
);

-- 用户角色关联表
CREATE TABLE user_roles (
    user_id UUID REFERENCES users(id),
    role_id UUID REFERENCES roles(id),
    PRIMARY KEY (user_id, role_id)
);

-- 文档表
CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(500) NOT NULL,
    source_url TEXT,
    source_type VARCHAR(50),  -- pdf, word, wiki, etc.
    file_path TEXT,
    department_id UUID,
    owner_id UUID REFERENCES users(id),
    permission_level VARCHAR(20), -- public, department, private
    status VARCHAR(20) DEFAULT 'processing', -- processing, indexed, failed
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    metadata JSONB
);

-- 文档权限表
CREATE TABLE document_permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_id UUID REFERENCES documents(id),
    user_id UUID REFERENCES users(id),
    role_id UUID REFERENCES roles(id),
    permission_type VARCHAR(20), -- read, write, admin
    created_at TIMESTAMP DEFAULT NOW()
);

-- 对话会话表
CREATE TABLE conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    title VARCHAR(200),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 消息表
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID REFERENCES conversations(id),
    role VARCHAR(20) NOT NULL, -- user, assistant
    content TEXT NOT NULL,
    sources JSONB,  -- 检索到的文档来源
    feedback INTEGER, -- 1: thumbs up, -1: thumbs down
    created_at TIMESTAMP DEFAULT NOW()
);

-- 审计日志表
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    action VARCHAR(50) NOT NULL,
    resource_type VARCHAR(50),
    resource_id UUID,
    details JSONB,
    ip_address INET,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 5.2 向量数据库 Schema

```python
# Milvus Collection Schema
from pymilvus import FieldSchema, CollectionSchema, DataType

fields = [
    # 主键
    FieldSchema(name="id", dtype=DataType.VARCHAR, max_length=36, is_primary=True),

    # 向量嵌入
    FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=1024),

    # 元数据
    FieldSchema(name="document_id", dtype=DataType.VARCHAR, max_length=36),
    FieldSchema(name="chunk_id", dtype=DataType.VARCHAR, max_length=36),
    FieldSchema(name="content", dtype=DataType.VARCHAR, max_length=65535),
    FieldSchema(name="department_id", dtype=DataType.VARCHAR, max_length=36),
    FieldSchema(name="permission_level", dtype=DataType.VARCHAR, max_length=20)),
    FieldSchema(name="created_at", dtype=DataType.INT64),
]

schema = CollectionSchema(fields=fields, description="Knowledge base chunks")
```

---

## 6. API 设计

### 6.1 RESTful API 接口

```
# 认证相关
POST   /api/v1/auth/login
POST   /api/v1/auth/logout
POST   /api/v1/auth/refresh
GET    /api/v1/auth/me

# 问答相关
POST   /api/v1/chat/completions        # 单次问答
POST   /api/v1/chat/conversations      # 创建会话
GET    /api/v1/chat/conversations      # 获取会话列表
GET    /api/v1/chat/conversations/:id  # 获取会话详情
DELETE /api/v1/chat/conversations/:id  # 删除会话
POST   /api/v1/chat/feedback           # 反馈

# 文档管理
POST   /api/v1/documents/upload        # 上传文档
GET    /api/v1/documents               # 文档列表
GET    /api/v1/documents/:id           # 文档详情
DELETE /api/v1/documents/:id           # 删除文档
PUT    /api/v1/documents/:id           # 更新文档
POST   /api/v1/documents/sync          # 同步外部数据源

# 文档权限
GET    /api/v1/documents/:id/permissions
POST   /api/v1/documents/:id/permissions
PUT    /api/v1/documents/:id/permissions/:permission_id
DELETE /api/v1/documents/:id/permissions/:permission_id

# 管理相关
GET    /api/v1/admin/stats             # 统计数据
GET    /api/v1/admin/audit-logs        # 审计日志
POST   /api/v1/admin/reindex           # 重建索引
```

### 6.2 问答请求示例

```json
POST /api/v1/chat/completions

{
  "conversation_id": "uuid",      // 可选，关联会话
  "query": "如何申请年假？",
  "stream": true,                 // 是否流式返回
  "retrieval_params": {
    "top_k": 10,
    "score_threshold": 0.7,
    "rerank": true
  }
}
```

### 6.3 问答响应示例

```json
{
  "id": "uuid",
  "answer": "根据公司制度，申请年假需要：\n1. 提前3个工作日提交申请\n2. 通过OA系统填写请假单\n3. 经部门主管审批\n4. HR确认后生效",
  "sources": [
    {
      "document_id": "uuid",
      "title": "员工手册 - 考勤管理制度",
      "chunk_id": "uuid",
      "score": 0.89,
      "url": "https://docs.company.com/employee-handbook"
    }
  ],
  "conversation_id": "uuid",
  "created_at": "2025-01-20T10:30:00Z"
}
```

---

## 7. 部署架构

### 7.1 生产环境部署

```
┌────────────────────────────────────────────────────────────────┐
│                        负载均衡 (LB)                            │
│                    Nginx / HAProxy / ALB                       │
└────────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────────┐
│                      Kubernetes 集群                           │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                    应用层 (Pods)                         │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │  │
│  │  │ API GW   │ │  Web     │ │ Question │ │ Document │  │  │
│  │  │ (x3)     │ │  (x2)    │ │ Service  │ │ Service  │  │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘  │  │
│  └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                    LLM 服务层                            │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐                 │  │
│  │  │ vLLM     │ │ Embedding│ │ Reranker │                 │  │
│  │  │ (x2)     │ │ (x2)     │ │ (x2)     │                 │  │
│  │  │ GPU 节点 │ │          │ │          │                 │  │
│  │  └──────────┘ └──────────┘ └──────────┘                 │  │
│  └─────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────────┐
│                        数据存储层                               │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │ Milvus   │ │PostgreSQL│ │  Redis   │ │  MinIO   │          │
│  │ x3       │ │  x2       │ │  x3       │ │  x2       │          │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘          │
└────────────────────────────────────────────────────────────────┘
```

### 7.2 资源规划

| 服务 | 实例 | CPU | 内存 | 存储 | GPU |
|------|------|-----|------|------|-----|
| API Gateway | 3 | 4C | 8G | - | - |
| Question Service | 3 | 8C | 16G | - | - |
| Document Service | 2 | 4C | 8G | - | - |
| Web Frontend | 2 | 2C | 4G | - | - |
| vLLM | 2 | 16C | 64G | 200G | A100 40G |
| Embedding Service | 2 | 8C | 32G | 50G | - |
| Milvus | 3 | 8C | 32G | 500G SSD | - |
| PostgreSQL | 2 | 8C | 32G | 500G SSD | - |
| Redis | 3 | 4C | 16G | 100G SSD | - |
| MinIO | 2 | 4C | 8G | 10T HDD | - |

---

## 8. 监控与运维

### 8.1 监控指标

#### 系统指标
- CPU、内存、磁盘使用率
- 网络流量
- Pod 状态

#### 业务指标
- QPS、响应时间
- 检索召回率、准确率
- 用户满意度（反馈评分）
- 文档索引状态

#### LLM 指标
- Token 吞吐量
- 模型响应时间
- API 调用成功率

### 8.2 告警规则

| 指标 | 阈值 | 级别 |
|------|------|------|
| API 响应时间 | P99 > 3s | Warning |
| API 错误率 | > 1% | Critical |
| LLM 响应时间 | > 10s | Warning |
| Milvus 查询延迟 | > 500ms | Warning |
| Redis 内存使用 | > 80% | Critical |

---

## 9. 安全设计

### 9.1 认证与授权
- JWT Token 认证
- RBAC 角色权限控制
- 文档级别权限映射到向量检索

### 9.2 数据安全
- 传输加密 (HTTPS/TLS)
- 敏感数据脱敏
- 定期备份

### 9.3 审计
- 全量操作日志
- 敏感操作告警
- 日志不可篡改

---

## 10. 实施路线

### 10.1 第一阶段：MVP (4-6 周)
- [ ] 基础问答能力
- [ ] 支持常见文档格式
- [ ] 用户认证和基础权限
- [ ] Web 界面

### 10.2 第二阶段：功能完善 (6-8 周)
- [ ] 对话历史管理
- [ ] 企业微信/钉钉集成
- [ ] 高级检索（混合检索、重排序）
- [ ] 文档管理后台

### 10.3 第三阶段：优化与扩展 (持续)
- [ ] 性能优化
- [ ] 知识图谱增强
- [ ] 多语言支持
- [ ] 移动端应用

---

## 11. 成本估算

### 11.1 硬件成本 (年度)

| 项目 | 配置 | 数量 | 单价 | 年度成本 |
|------|------|------|------|----------|
| GPU 服务器 | A100 40G | 2 | ¥200,000 | ¥400,000 |
| 应用服务器 | 16C/64G | 6 | ¥30,000 | ¥180,000 |
| 存储服务器 | 50T SSD | 3 | ¥50,000 | ¥150,000 |
| 网络/带宽 | 100Mbps | 1 | ¥20,000 | ¥20,000 |
| **合计** | | | | **¥750,000** |

### 11.2 人力成本 (年度)

| 角色 | 人数 | 月均成本 | 年度成本 |
|------|------|----------|----------|
| 后端开发 | 2 | ¥25,000 | ¥600,000 |
| 前端开发 | 1 | ¥20,000 | ¥240,000 |
| 运维工程师 | 1 | ¥20,000 | ¥240,000 |
| **合计** | | | **¥1,080,000** |

### 11.3 总成本
**首年总成本：¥180万+**
- 硬件采购：¥75万
- 人力成本：¥108万
- 其他（软件、培训等）：¥20万

---

## 12. 风险与应对

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| LLM 生成不准确答案 | 高 | 中 | RAG 优化、人工审核、反馈机制 |
| 数据泄露 | 高 | 低 | 权限管控、审计、加密 |
| 性能瓶颈 | 中 | 中 | 缓存、异步处理、扩容 |
| 模型更新 | 中 | 高 | 模型版本管理、灰度发布 |

---

## 13. 参考资料

### 开源项目
- [LangChain](https://github.com/langchain-ai/langchain)
- [LlamaIndex](https://github.com/run-llama/llama_index)
- [Milvus](https://github.com/milvus-io/milvus)
- [Qwen](https://github.com/QwenLM/Qwen)
- [vLLM](https://github.com/vllm-project/vllm)

### 技术文档
- [RAG 技术综述](https://arxiv.org/abs/2312.10997)
- [Milvus 官方文档](https://milvus.io/docs)
- [LangChain 文档](https://python.langchain.com)

---

*文档版本：v1.0*
*更新时间：2025-01-20*
